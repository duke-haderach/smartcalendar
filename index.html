<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Wall Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Load Google API Client Library -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <!-- Load NEW Google Identity Services (GIS) -->
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: Arial, sans-serif;
  color: #ffffff;
  overflow: hidden;
}
body {
  background-image: url("background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
/* TWO COLUMNS: left (clock+events), right (weather+stock) */
.overlay {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top, rgba(0,0,0,0.35), rgba(0,0,0,0.85));
  display: flex;
  flex-direction: row;
  padding: 16px;
  box-sizing: border-box;
}
/* LEFT COLUMN */
.left-panel {
  flex: 2;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
/* RIGHT COLUMN */
.right-panel {
  flex: 1;
  display: flex;
  flex-direction: column; /* weather above, stock below */
  gap: 16px;
  margin-left: 16px;
  min-height: 0;
}
/* Weather ~60%, stock ~40% of right column */
#weather-panel {
  flex: 3 1 0;
  min-height: 180px;
  max-height: 1060px;
  overflow-y: auto;
}
#stock-panel {
  flex: 2 1 0;
  min-height: 140px;
}
.panel {
  background: rgba(0, 0, 0, 0.45);
  border-radius: 8px;
  padding: 12px 16px;
  box-sizing: border-box;
}
#clock {
  font-size: 32px;
  font-weight: 600;
}
#date {
  font-size: 18px;
  opacity: 0.8;
}
#events-container {
  max-height: 800px;
  overflow-y: auto;
}
#events {
  flex: 1;
  overflow-y: auto;
  font-size: 16px;
  max-height: 100%;
}
.event-day {
  margin-top: 10px;
  font-weight: 600;
  font-size: 15px;
  opacity: 0.9;
}
.event-item {
  margin-top: 4px;
  padding: 4px 6px;
  background: rgba(0, 255, 0, 0.05);
  border-radius: 4px;
  color: #f7f5f5;
  font-size: 15px;
  font-weight: bold;
}
.event-time {
  font-weight: 600;
  margin-right: 6px;
}
.event-location {
  display: block;
  font-size: 12px;
  color: #e3dede;
  margin-left: 65px;
}
/* WEATHER: portrait list */
#weather-current {
  font-size: 22px;
  font-weight: 600;
}
#weather-forecast {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 14px;
}
.weather-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 6px;
  background: rgba(255,255,255,0.07);
  border-radius: 4px;
}
.weather-icon {
  width: 38px;
  height: 38px;
  margin-right: 8px;
}
.weather-name {
  width: 80px;
  font-weight: 600;
}
.weather-temp {
  font-weight: 600;
  margin-right: 10px;
}
.weather-desc {
  opacity: 0.9;
  flex: 1;
  text-align: right;
}
/* Enable‑voice button */
#enable-voice {
  display: none;
  padding: 6px 10px;
  margin-top: 6px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ffffff;
  background: rgba(255,255,255,0.1);
  color: #ffffff;
  cursor: pointer;
}
#enable-voice:hover {
  background: rgba(255,255,255,0.25);
}
/* Sign-in button */
#sign-in {
  padding: 8px 16px;
  margin-top: 6px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ffffff;
  background: rgba(255,255,255,0.1);
  color: #ffffff;
  cursor: pointer;
  display: inline-block;
}
#sign-in:hover {
  background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
<div class="overlay">
  <!-- LEFT column: clock + events -->
  <div class="left-panel">
    <div class="panel">
      <div id="clock">--:--</div>
      <div id="date">Loading date…</div>
    </div>
    <div class="panel" id="events-panel">
      <div style="font-size:18px;font-weight:600;margin-bottom:6px;">
        Upcoming Events
      </div>
      <div id="auth-status">Click "Sign in with Google" to load events</div>
      <button id="sign-in">Sign in with Google</button>
      <button id="enable-voice">Enable voice alerts</button>
      <div id="events-container">
        <div id="events"></div>
      </div>
    </div>
  </div>
  <!-- RIGHT column: weather + stock -->
  <div class="right-panel">
    <div class="panel" id="weather-panel">
      <div id="weather-current">Loading weather…</div>
      <div id="weather-forecast"></div>
    </div>
    <div class="panel" id="stock-panel">
      <div id="tradingview-widget" style="width:100%;height:100%;"></div>
    </div>
  </div>
</div>

<script>
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.log('Global error:', msg, 'at', url, ':', lineNo);
  document.getElementById("auth-status").textContent = "JS Error: " + msg;
  return false;
};
// ===== CLOCK =====
function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent = now.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });
  document.getElementById("date").textContent = now.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric",
  });
}
setInterval(updateClock, 1000);
updateClock();


// ===== SIMPLE GOOGLE AUTH TEST =====
console.log("TEST: Script is running");

// 1. Set up a simple button handler FIRST
document.addEventListener('DOMContentLoaded', function() {
  console.log("TEST: DOM is ready");
  
  const signInBtn = document.getElementById("sign-in");
  if (signInBtn) {
    console.log("TEST: Found sign-in button");
    
    // Force enable the button with a simple test
    signInBtn.disabled = false;
    signInBtn.onclick = function() {
      console.log("TEST: Button was clicked!");
      document.getElementById("auth-status").textContent = "Button works! Testing popup...";
      
      // Try to open ANY popup
      const testPopup = window.open('https://google.com', 'test', 'width=500,height=500');
      if (!testPopup) {
        document.getElementById("auth-status").textContent = "POPUP BLOCKED! Allow popups for this site.";
      }
    };
    
    document.getElementById("auth-status").textContent = "Ready - Click 'Sign in with Google'";
  } else {
    console.error("TEST: Could not find sign-in button!");
  }
});

// Check if Google libraries exist
console.log("TEST: window.gapi exists?", typeof window.gapi);
console.log("TEST: window.google exists?", typeof window.google);
// ===== GOOGLE CALENDAR AUTH + LOAD =====
// Replace these with your actual credentials
// const CLIENT_ID = "703875968822-6ma5u7st5qm3eqgb1ktt9p52vs8knrb3.apps.googleusercontent.com";
// const API_KEY = "AIzaSyCcx8q0nHP9DkA-M_KFyjFo-uLV-7TOrSE";
// const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
// const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";

// let tokenClient; // The new GIS token client
// let gapiInited = false;
// let gisInited = false;

// // 1. Load the Google API Client Library (gapi)
// function gapiLoaded() {
//   console.log("gapi.js loaded");
//   // Load the 'client' module which contains gapi.client.init
//   gapi.load('client', initializeGapiClient);
// }

// // 2. Initialize gapi.client
// async function initializeGapiClient() {
//   console.log("Initializing gapi.client...");
//   try {
//     await gapi.client.init({
//       apiKey: API_KEY,
//       discoveryDocs: [DISCOVERY_DOC],
//     });
//     gapiInited = true;
//     console.log("gapi.client initialized.");
//     maybeEnableAuthButton();
//   } catch (error) {
//     console.error("Error initializing gapi.client:", error);
//     document.getElementById("auth-status").textContent = "Failed to load Google API client.";
//   }
// }

// // 3. Initialize the Google Identity Services (GIS) token client
// function gisLoaded() {
//   console.log("GIS (Identity Services) loaded.");
//   // This is the NEW, correct way to create a token client
//   tokenClient = google.accounts.oauth2.initTokenClient({
//     client_id: CLIENT_ID,
//     scope: SCOPES,
//     callback: (tokenResponse) => {
//       // This runs AFTER the user completes the OAuth popup
//       console.log("Token callback fired.", tokenResponse);
//       if (tokenResponse && tokenResponse.access_token) {
//         // Success! Give the token to gapi.client
//         gapi.client.setToken(tokenResponse);
//         document.getElementById("auth-status").textContent = "Signed in! Loading calendar...";
//         document.getElementById("sign-in").style.display = "none"; // Hide sign-in button
//         loadCalendarEvents();
//       } else {
//         // User closed the popup or denied permission
//         console.error("Auth failed or was cancelled.", tokenResponse);
//         document.getElementById("auth-status").textContent = "Sign-in was cancelled.";
//       }
//     },
//     error_callback: (error) => {
//       console.error("GIS Error in token flow:", error);
//       document.getElementById("auth-status").textContent = "A sign-in error occurred.";
//     }
//   });
//   gisInited = true;
//   console.log("GIS token client ready.");
//   maybeEnableAuthButton();
// }

// // 4. Enable the button only when both libraries are ready
// function maybeEnableAuthButton() {
//   const signInBtn = document.getElementById("sign-in");
//   if (gapiInited && gisInited && signInBtn) {
//     console.log("Both libraries ready. Enabling sign-in button.");
//     signInBtn.disabled = false;
//     signInBtn.onclick = handleAuthClick;
//     document.getElementById("auth-status").textContent = "Ready. Click 'Sign in with Google'.";
//   }
// }

// // 5. Handle the actual button click
// function handleAuthClick() {
//   console.log("handleAuthClick: Triggering OAuth popup via tokenClient.");
//   document.getElementById("auth-status").textContent = "Opening Google sign-in...";
  
//   // THIS LINE TRIGGERS THE GOOGLE OAUTH POPUP
//   tokenClient.requestAccessToken();
// }

// // 6. Load calendar events (unchanged from your working version)
// async function loadCalendarEvents() {
//   console.log("loadCalendarEvents called");
//   try {
//     const now = new Date();
//     const timeMin = now.toISOString();
//     const timeMax = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

//     const resp = await gapi.client.calendar.events.list({
//       calendarId: "family03331431524389313579@group.calendar.google.com",
//       timeMin,
//       timeMax,
//       showDeleted: false,
//       singleEvents: true,
//       orderBy: "startTime",
//       maxResults: 100,
//     });
    
//     console.log("Events loaded successfully:", resp.result.items ? resp.result.items.length : 0);
//     const events = resp.result.items || [];
    
//     if (!events.length) {
//       document.getElementById("events").textContent = "No upcoming events.";
//       return;
//     }

//     renderEvents(events);
//     // Save for voice reminders and persistence
//     localStorage.setItem('calendarEvents', JSON.stringify(events));
//     localStorage.setItem('eventsLastUpdated', Date.now());

//     // Show the voice alerts button
//     const voiceBtn = document.getElementById("enable-voice");
//     voiceBtn.style.display = "inline-block";
//     voiceBtn.onclick = () => {
//       console.log("Enabling voice alerts.");
//       scheduleVoiceReminders(events);
//       voiceBtn.style.display = "none";
//       document.getElementById("auth-status").textContent = "Voice alerts are active!";
//     };
    
//   } catch (err) {
//     console.error("Calendar error:", err);
//     document.getElementById("auth-status").textContent = "Error loading calendar.";
//     // If token is invalid, clear it so user can sign in again
//     if (err.status === 401) {
//       gapi.client.setToken(null);
//       document.getElementById("sign-in").style.display = "inline-block";
//     }
//   }
// }

// function renderEvents(events) {
//   const container = document.getElementById("events");
//   container.innerHTML = "";

//   const byDate = {};
//   events.forEach((ev) => {
//     const start = ev.start.dateTime || ev.start.date;
//     const d = new Date(start);
//     const key = d.toDateString();
//     if (!byDate[key]) byDate[key] = [];
//     byDate[key].push({ raw: ev, date: d });
//   });

//   Object.keys(byDate)
//     .sort((a, b) => new Date(a) - new Date(b))
//     .forEach((key) => {
//       const dayHeader = document.createElement("div");
//       dayHeader.className = "event-day";
//       dayHeader.textContent = key;
//       container.appendChild(dayHeader);

//       byDate[key]
//         .sort((a, b) => a.date - b.date)
//         .forEach((e) => {
//           const item = document.createElement("div");
//           item.className = "event-item";

//           const timeSpan = document.createElement("span");
//           timeSpan.className = "event-time";
//           const isAllDay = !!e.raw.start.date;
//           timeSpan.textContent = isAllDay
//             ? "All day"
//             : e.date.toLocaleTimeString([], {
//                 hour: "numeric",
//                 minute: "2-digit",
//                 hour12: true,
//               });

//           const titleSpan = document.createElement("span");
//           titleSpan.className = "event-title";
//           titleSpan.textContent = e.raw.summary || "(No title)";

//           item.appendChild(timeSpan);
//           item.appendChild(titleSpan);

//           if (e.raw.location) {
//             const locDiv = document.createElement("div");
//             locDiv.className = "event-location";
//             locDiv.textContent = e.raw.location;
//             item.appendChild(locDiv);
//           }

//           container.appendChild(item);
//         });
//     });
// }

// ===== OPEN-METEO WEATHER =====
const LAT = 38.81;
const LON = -90.72;

function loadWeather() {
  const url =
    "https://api.open-meteo.com/v1/forecast?" +
    "latitude=" +
    LAT +
    "&longitude=" +
    LON +
    "&daily=temperature_2m_max,temperature_2m_min,weathercode" +
    "&temperature_unit=fahrenheit" +
    "&current_weather=true&timezone=auto";

  fetch(url)
    .then((r) => r.json())
    .then((data) => renderWeather(data))
    .catch((err) => {
      document.getElementById("weather-current").textContent = "Weather error";
      console.error(err);
    });
}

function renderWeather(data) {
  const current = data.current_weather;
  const daily = data.daily;

  const currentEl = document.getElementById("weather-current");
  currentEl.textContent =
    Math.round(current.temperature) + "° " + mapWeatherCode(current.weathercode);

  const forecastEl = document.getElementById("weather-forecast");
  forecastEl.innerHTML = "";

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const days = daily.time.length;
  let shown = 0;

  for (let i = 0; i < days && shown < 7; i++) {
    const d = new Date(daily.time[i]);
    const localDay = new Date(d);
    localDay.setHours(0, 0, 0, 0);
    if (localDay < today) continue;

    const row = document.createElement("div");
    row.className = "weather-day";

    const iconEl = document.createElement("img");
    iconEl.className = "weather-icon";
    iconEl.src = getWeatherIcon(daily.weathercode[i]);
    iconEl.alt = mapWeatherCode(daily.weathercode[i]);

    const nameEl = document.createElement("div");
    nameEl.className = "weather-name";
    nameEl.textContent = d.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
    });

    const tempEl = document.createElement("div");
    tempEl.className = "weather-temp";
    const hi = Math.round(daily.temperature_2m_max[i]);
    const lo = Math.round(daily.temperature_2m_min[i]);
    tempEl.textContent = hi + "° / " + lo + "°";

    const descEl = document.createElement("div");
    descEl.className = "weather-desc";
    descEl.textContent = mapWeatherCode(daily.weathercode[i]);

    row.appendChild(iconEl);
    row.appendChild(nameEl);
    row.appendChild(tempEl);
    row.appendChild(descEl);
    forecastEl.appendChild(row);
    shown++;
  }
}

function getWeatherIcon(code) {
  if (code === 0) return "icons/clear.png";
  if ([1, 2, 3].includes(code)) return "icons/partly-cloudy.png";
  if ([45, 48].includes(code)) return "icons/fog.png";
  if ([51, 53, 55, 56, 57].includes(code)) return "icons/drizzle.png";
  if ([61, 63, 65, 80, 81, 82].includes(code)) return "icons/rain.png";
  if ([71, 73, 75, 77, 85, 86].includes(code)) return "icons/snow.png";
  if ([95, 96, 99].includes(code)) return "icons/storm.png";
  return "icons/unknown.png";
}

function mapWeatherCode(code) {
  if (code === 0) return "Clear";
  if ([1, 2, 3].includes(code)) return "Cloudy";
  if ([45, 48].includes(code)) return "Fog";
  if ([51, 53, 55, 56, 57].includes(code)) return "Drizzle";
  if ([61, 63, 65, 80, 81, 82].includes(code)) return "Rain";
  if ([71, 73, 75, 77, 85, 86].includes(code)) return "Snow";
  if ([95, 96, 99].includes(code)) return "Storm";
  return "N/A";
}

loadWeather();
setInterval(loadWeather, 60 * 60 * 1000);

// ===== VOICE REMINDERS =====
let reminderCheckInterval = null;
let spokenEvents = new Set(); // Track already spoken reminders

function parseCalendarDate(dateString) {
    return new Date(dateString);
}

function scheduleVoiceReminders(events) {
    console.log("Starting voice reminder scheduler");
    
    if (!("speechSynthesis" in window)) {
        console.log("No speechSynthesis support");
        return;
    }
    
    if (reminderCheckInterval) {
        clearInterval(reminderCheckInterval);
        spokenEvents.clear();
    }
    
    reminderCheckInterval = setInterval(() => checkReminders(events), 30000);
    checkReminders(events);
}

function checkReminders(events) {
    const now = new Date();
    const nowMs = now.getTime();
    
    events.forEach(ev => {
        if (!ev.start || !ev.start.dateTime) return;
        
        const eventStart = parseCalendarDate(ev.start.dateTime);
        const eventStartMs = eventStart.getTime();
        const eventId = ev.id || ev.summary;
        
        const minutesUntilEvent = (eventStartMs - nowMs) / (60 * 1000);
        
        if (minutesUntilEvent <= 30 && minutesUntilEvent > 29.5) {
            const reminderKey = `${eventId}_30min`;
            if (!spokenEvents.has(reminderKey)) {
                speakReminder(ev, 30);
                spokenEvents.add(reminderKey);
            }
        }
        
        if (minutesUntilEvent <= 15 && minutesUntilEvent > 14.5) {
            const reminderKey = `${eventId}_15min`;
            if (!spokenEvents.has(reminderKey)) {
                speakReminder(ev, 15);
                spokenEvents.add(reminderKey);
            }
        }
    });
}

function speakReminder(event, minutesBefore) {
    console.log(`[${minutesBefore}] Speaking reminder for:`, event.summary);
    const msg = `Reminder. Event "${event.summary || "Untitled"}" starts in ${minutesBefore} minutes.`;
    const utter = new SpeechSynthesisUtterance(msg);
    utter.rate = 1.0;
    utter.pitch = 1.0;
    utter.volume = 1.0;
    
    window.speechSynthesis.cancel();
    
    setTimeout(() => {
        window.speechSynthesis.speak(utter);
    }, 100);
}

function cleanupOldReminders() {
    const now = Date.now();
    for (const key of spokenEvents) {
        spokenEvents.delete(key);
    }
    const lastUpdated = localStorage.getItem('eventsLastUpdated');
    if (lastUpdated && (now - lastUpdated > 24 * 60 * 60 * 1000)) {
        localStorage.removeItem('calendarEvents');
        localStorage.removeItem('eventsLastUpdated');
    }
}

setInterval(cleanupOldReminders, 24 * 60 * 60 * 1000);

// On page load, check for existing events and initialize
window.addEventListener('load', () => {
    console.log("Page loaded.");
    const savedEvents = localStorage.getItem('calendarEvents');
    const lastUpdated = localStorage.getItem('eventsLastUpdated');
    if (savedEvents && lastUpdated && (Date.now() - lastUpdated < 60 * 60 * 1000)) {
        const events = JSON.parse(savedEvents);
        renderEvents(events);
        const btn = document.getElementById("enable-voice");
        btn.style.display = "inline-block";
        btn.onclick = () => {
            scheduleVoiceReminders(events);
            btn.style.display = "none";
            document.getElementById("auth-status").textContent = "Voice alerts enabled!";
        };
    }
});
</script>

<!-- TradingView stock widget -->
<script type="text/javascript">
(function () {
  const container = document.getElementById("tradingview-widget");
  if (!container) return;
  const script = document.createElement("script");
  script.src =
    "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
  script.async = true;
  script.innerHTML = JSON.stringify({
    symbols: [["SPY", "AMEX:SPY|1M"]],
    chartOnly: false,
    width: "100%",
    height: "100%",
    locale: "en",
    colorTheme: "dark",
    autosize: true,
    showVolume: true,
  });
  container.style.height = "100%";
  container.appendChild(script);
})();
</script>
</body>
</html>





