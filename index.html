<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Wall Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: Arial, sans-serif;
  color: #ffffff;
  overflow: hidden;
}
body {
  background-image: url("background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
/* TWO COLUMNS: left (clock+events), right (weather+stock) */
.overlay {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top, rgba(0,0,0,0.35), rgba(0,0,0,0.85));
  display: flex;
  flex-direction: row;
  padding: 16px;
  box-sizing: border-box;
  gap: 16px;
}

/* ===== LEFT COLUMN - TWO ROW LAYOUT ===== */
.left-panel {
  flex: 7; /* 70% of screen width */
  display: flex;
  flex-direction: column;
  gap: 12px; /* Gap between the two rows */
  height: 100%;
}

/* Row 1: Clock + Transactions */
.row-1 {
  flex: 0 0 auto; /* Don't grow, don't shrink */
  display: flex;
  gap: 12px;
  height: 30%; /* Approximately 30% of left panel */
  min-height: 200px;
}

/* Clock Panel */
.clock-panel {
  flex: 0.5; /* Take half of row 1 */
  background: rgba(0, 0, 0, 0.45);
  border-radius: 8px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0;
}

/* Transactions Panel */
.transactions-panel {
  flex: 1.5; /* Take half of row 1 */
  background: rgba(0, 0, 0, 0.45);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

/* Row 2: Events */
.events-panel {
  flex: 1; /* Take remaining 70% of left panel */
  background: rgba(0, 0, 0, 0.45);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 400px;
}

/* ===== CLOCK STYLING ===== */
#clock {
  font-size: 36px;
  font-weight: 700;
  line-height: 1.2;
  margin-bottom: 4px;
  text-align: center;
}
#date {
  font-size: 18px;
  opacity: 0.8;
  line-height: 1.2;
  text-align: center;
}

/* ===== TRANSACTIONS PANEL STYLING ===== */
.transactions-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.transactions-title-container {
  display: flex;
  flex-direction: column;
  flex: 1;
}

/* Add this to target the Credit Card Balances text */
.transactions-title-container > div:first-child {
  font-size: 10px; /* Reduced from default */
  font-weight: 600;
  margin-bottom: 2px;
}

#last-updated {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 4px;
  font-style: italic;
}

/* Compact table styling */
.cards-table-container {
  flex: 1;
  overflow-y: auto;
  max-height: calc(100% - 50px);
}

.cards-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.cards-table th {
  text-align: left;
  padding: 8px 10px;
  background: rgba(255, 255, 255, 0.1);
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  font-size: 12px;
  position: sticky;
  top: 0;
  z-index: 10;
}

.cards-table td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.cards-table tr:hover {
  background: rgba(255, 255, 255, 0.03);
}

.cards-table .amount {
  text-align: right;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

.cards-table .total-row {
  background: rgba(255, 255, 255, 0.1);
  font-weight: 600;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.cards-table .total-row td {
  padding: 10px 10px;
  font-size: 13px;
}

/* Sync button styling */
#sync-sheets-btn {
  padding: 8px 14px;
  background: rgba(66, 133, 244, 0.3);
  color: #4285F4;
  border: 1px solid rgba(66, 133, 244, 0.7);
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

/* Styling for the total balance display */
#total-balance {
  background: rgba(0, 0, 0, 0.3);
  padding: 6px 12px;
  border-radius: 6px;
  border-left: 3px solid currentColor;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Make table header more compact */
.cards-table th {
  font-size: 11px !important;
  padding: 6px 10px !important;
  opacity: 0.8;
}

/* Make table rows more compact */
.cards-table td {
  padding: 6px 10px !important;
  font-size: 12px !important;
}

/* Highlight the amount column */
.cards-table .amount {
  font-family: 'Courier New', monospace !important;
  font-weight: 600 !important;
}

/* Optional: Add subtle hover effect on total */
#total-balance:hover {
  transform: translateY(-1px);
  transition: transform 0.2s;
}

#sync-sheets-btn:hover {
  background: rgba(66, 133, 244, 0.4);
  box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
}

/* ===== EVENTS PANEL STYLING ===== */
#auth-status {
  font-size: 14px;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#events-container {
  flex: 1;
  overflow-y: auto;
  max-height: 100%;
}

#events {
  flex: 1;
  overflow-y: auto;
  font-size: 14px;
}

.event-day {
  margin-top: 12px;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 15px;
  opacity: 0.9;
  color: #4CAF50;
}

.event-item {
  margin-bottom: 8px;
  padding: 8px 10px;
  background: rgba(0, 255, 0, 0.05);
  border-radius: 6px;
  color: #f7f5f5;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  border-left: 3px solid #4CAF50;
}

.event-time-container {
  display: flex;
  flex-direction: column;
  min-width: 25%;
  margin-right: 12px;
}

.event-time {
  font-weight: 600;
  white-space: nowrap;
  font-size: 14px;
}

.event-end-time {
  font-size: 11px;
  color: #e3dede;
  margin-top: 2px;
  white-space: nowrap;
}

.event-title {
  flex: 1;
  min-width: 60%;
  line-height: 1.3;
  font-size: 14px;
}

.event-location {
  display: block;
  font-size: 12px;
  color: #e3dede;
  margin-top: 4px;
  width: 100%;
  margin-left: 0.5%;
}

.event-right {
  flex: 1;
  min-width: 60%;
  display: flex;
  flex-direction: column;
}

/* Auth buttons */
#sign-in, #enable-voice {
  padding: 8px 16px;
  margin-top: 6px;
  margin-right: 10px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ffffff;
  background: rgba(255,255,255,0.1);
  color: #ffffff;
  cursor: pointer;
  display: inline-block;
}

#sign-in:hover, #enable-voice:hover {
  background: rgba(255,255,255,0.25);
}

/* Add smooth transitions for sign-in button */
#sign-in, #auth-status {
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* When hiding, smoothly fade out */
#sign-in[style*="display: none"] {
  opacity: 0;
  transform: translateY(-10px);
  height: 0;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

/* When showing, smoothly fade in */
#sign-in {
  opacity: 1;
  transform: translateY(0);
}

/* ===== RIGHT COLUMN ===== */
.right-panel {
    flex: 3 !important;
    min-width: 300px !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
    min-height: 0 !important;
}

#weather-panel {
  flex: 4 1 0;
  min-height: 180px;
  max-height: 1060px;
  overflow-y: auto;
}

#youtube-panel {
  flex: 3 1 0 !important;
    min-height: 200px !important;
    max-height: 500px !important;
    overflow: hidden !important;
    position: relative !important;
}

#stock-panel {
  flex: 3 1 0;
  min-height: 140px;
}

/* Ensure YouTube panel doesn't push other panels */
#weather-panel, #stock-panel {
    flex-shrink: 0 !important;
}

.panel {
  background: rgba(0, 0, 0, 0.45);
  border-radius: 8px;
  padding: 16px;
  box-sizing: border-box;
}

/* Hide the old inline results */
#youtube-results-container {
  display: none !important;
}

/* Loading spinner for popup */
.youtube-loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* YouTube Search Results Popup */
#youtube-results-popup {
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  width: 80% !important;
  max-width: 600px !important;
  max-height: 80vh !important;
  background: rgba(0, 0, 0, 0.95) !important;
  border-radius: 12px !important;
  border: 2px solid rgba(255, 0, 0, 0.5) !important;
  z-index: 10000 !important;
  box-shadow: 0 10px 40px rgba(0,0,0,0.7) !important;
  overflow: hidden !important;
  display: none !important;
}

#youtube-results-popup-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 15px 20px !important;
  background: rgba(255,0,0,0.15) !important;
  border-bottom: 1px solid rgba(255,255,255,0.2) !important;
}

#youtube-results-popup-header span {
  font-weight: 600 !important;
  font-size: 16px !important;
}

#youtube-close-popup {
  padding: 6px 14px !important;
  background: rgba(255,255,255,0.1) !important;
  color: white !important;
  border: none !important;
  border-radius: 4px !important;
  cursor: pointer !important;
  font-size: 14px !important;
  transition: all 0.2s !important;
}

#youtube-close-popup:hover {
  background: rgba(255,255,255,0.2) !important;
}

#youtube-results-popup-list {
  max-height: calc(80vh - 70px) !important;
  overflow-y: auto !important;
  padding: 10px !important;
}

/* Popup result items */
.youtube-popup-result-item {
  padding: 12px 15px !important;
  border-bottom: 1px solid rgba(255,255,255,0.05) !important;
  cursor: pointer !important;
  display: flex !important;
  gap: 15px !important;
  align-items: flex-start !important;
  transition: all 0.2s !important;
  border-radius: 6px !important;
  margin-bottom: 5px !important;
}

.youtube-popup-result-item:hover {
  background: rgba(255,255,255,0.05) !important;
  transform: translateX(3px) !important;
}

.youtube-popup-result-thumb {
  width: 100px !important;
  height: 75px !important;
  border-radius: 6px !important;
  object-fit: cover !important;
  flex-shrink: 0 !important;
}

.youtube-popup-result-info {
  flex: 1 !important;
  overflow: hidden !important;
}

.youtube-popup-result-title {
  font-size: 14px !important;
  font-weight: 600 !important;
  margin-bottom: 6px !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
  overflow: hidden !important;
  line-height: 1.3 !important;
}

.youtube-popup-result-channel {
  font-size: 12px !important;
  opacity: 0.8 !important;
  margin-bottom: 4px !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

.youtube-popup-result-duration {
  font-size: 11px !important;
  opacity: 0.6 !important;
  color: #ff4444 !important;
}

/* Popup overlay background */
#youtube-popup-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: rgba(0, 0, 0, 0.85) !important;
  backdrop-filter: blur(5px) !important;
  z-index: 9999 !important;
  display: none !important;
}

/* Make sure iframe stays below popup */
#youtube-player iframe {
  z-index: 1 !important;
}

/* ===== WEATHER STYLING ===== */
#weather-current {
  font-size: 22px;
  font-weight: 600;
}

#weather-forecast {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 14px;
}

.weather-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  background: rgba(255,255,255,0.07);
  border-radius: 4px;
  cursor: pointer;
}

.weather-icon {
  width: 38px;
  height: 38px;
  margin-right: 8px;
}

.weather-name {
  width: 80px;
  font-weight: 600;
  font-size: 13px;
}

.weather-temp {
  font-weight: 600;
  margin-right: 10px;
  margin-left: 15px;
  font-size: 13px;
}

.weather-desc {
  opacity: 0.9;
  flex: 1;
  text-align: right;
  margin-left: 15px;
  font-size: 12px;
}

#weather-hourly-detail {
  margin-top: 8px;
  font-size: 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
  padding: 8px 10px;
  max-height: 400px;
  overflow-y: auto;
}

.weather-hourly-title {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 13px;
}

.weather-hourly-row {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  font-size: 12px;
}

.weather-hourly-row:last-child {
  border-bottom: none;
}

.weather-day.selected {
  background: rgba(255,255,255,0.15);
}

.weather-hourly-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

#weather-back-btn {
  margin-right: 10px;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #ffffff;
  background: rgba(255,255,255,0.1);
  color: #ffffff;
  cursor: pointer;
}

#weather-back-btn:hover {
  background: rgba(255,255,255,0.25);
}

.weather-hourly-list {
  font-size: 13px;
  max-height: 400px;
  overflow-y: auto;
}

/* ===== YOUTUBE STYLING ===== */
#youtube-widget-container {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
}

#youtube-search-section {
    display: flex;
    gap: 0;
    margin-bottom: 12px;
    width: 100%;
}

#youtube-search-input {
    flex: 1;
    padding: 10px 12px;
    border-radius: 4px 0 0 4px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(0,0,0,0.6);
    color: white;
    font-size: 14px;
    border-right: none;
    min-width: 150px;
}

#youtube-search-btn {
    padding: 0 15px;
    background: #ff0000;
    color: white;
    border: 1px solid #ff0000;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    display: flex !important;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    visibility: visible !important;
    opacity: 1 !important;
}

#youtube-search-btn:hover {
    background: #cc0000;
}

#youtube-player-area {
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    height: 180px !important;
    width: 100% !important;
    position: relative !important;
    margin-bottom: 10px !important;
}

#youtube-player {
    width: 100% !important;
    height: 100% !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    background: #000 !important;
    border-radius: 4px !important;
    overflow: hidden !important;
}

#youtube-video-info {
    padding: 8px 0;
}

#youtube-video-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#youtube-video-channel {
    font-size: 12px;
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.youtube-section-title {
    font-size: 13px;
    opacity: 0.8;
    margin-bottom: 8px;
    font-weight: 600;
}

.youtube-button-group {
    display: flex;
    gap: 8px;
}

.youtube-btn {
    flex: 1;
    padding: 8px 5px;
    background: rgba(255, 0, 0, 0.15);
    color: white;
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    transition: all 0.2s;
}

.youtube-btn:hover {
    background: rgba(255, 0, 0, 0.25);
    transform: translateY(-1px);
}

.youtube-btn-icon {
    font-size: 16px;
}

#youtube-results-container {
    position: absolute;
    top: 50px;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    max-height: 300px;
    overflow: hidden;
}

#youtube-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: rgba(255,0,0,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

#youtube-results-header span {
    font-weight: 600;
    font-size: 14px;
}

#youtube-close-results {
    padding: 4px 10px;
    background: rgba(255,255,255,0.1);
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

#youtube-close-results:hover {
    background: rgba(255,255,255,0.2);
}

#youtube-results-list {
    max-height: 250px;
    overflow-y: auto;
    padding: 5px;
}

.youtube-result-item {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.youtube-result-item:hover {
    background: rgba(255,255,255,0.05);
}

.youtube-result-thumb {
    width: 80px;
    height: 60px;
    border-radius: 4px;
    object-fit: cover;
    flex-shrink: 0;
}

.youtube-result-info {
    flex: 1;
    overflow: hidden;
}

.youtube-result-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.youtube-result-channel {
    font-size: 11px;
    opacity: 0.8;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#youtube-player iframe {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    border: none !important;
}

/* ===== TRADINGVIEW STYLING ===== */
.tradingview-widget-copyright {
  font-size: 9px !important;
  opacity: 0.6 !important;
}

.tradingview-widget-container .logo {
  transform: scale(0.7) !important;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1024px) {
  .overlay {
    padding: 12px;
    gap: 12px;
  }
  
  .left-panel {
    flex: 7;
  }
  
  .right-panel {
    flex: 3 !important;
    min-width: 250px !important;
  }
  
  .row-1 {
    height: 35%;
    min-height: 180px;
  }
  
  #clock {
    font-size: 32px;
  }
  
  #date {
    font-size: 16px;
  }
  
  .event-time-container {
    min-width: 28%;
    margin-right: 10px;
  }
  
  .event-time {
    font-size: 13px;
  }

  .event-end-time {
    font-size: 11px;
  }
  
  .event-title {
    font-size: 13px;
    min-width: 60%;
  }
  
  .event-location {
    font-size: 11px;
    margin-left: 0.5%;
  }
  
  .weather-day {
    padding: 5px 6px;
    font-size: 13px;
  }
  
  .weather-icon {
    width: 34px;
    height: 34px;
    margin-right: 6px;
  }
  
  .weather-name {
    width: 75px;
    font-size: 12px;
  }
  
  .weather-temp, .weather-desc {
    font-size: 12px;
  }
  
  #youtube-player-area {
    height: 160px !important;
  }
  
  #youtube-search-input {
    padding: 9px 11px;
    font-size: 13px;
    min-width: 130px;
  }
  
  #youtube-search-btn {
    font-size: 15px;
    padding: 0 12px;
    min-width: 40px;
  }
  
  .youtube-button-group {
    gap: 6px;
  }
  
  .youtube-btn {
    padding: 7px 4px;
    font-size: 11px;
  }
  
  .youtube-btn-icon {
    font-size: 14px;
  }
  
  #sign-in, #enable-voice {
    padding: 7px 14px;
    font-size: 13px;
  }
  
  .cards-table th,
  .cards-table td {
    padding: 6px 8px;
    font-size: 12px;
  }
  
  .cards-table .amount {
    font-size: 12px;
  }
}

/* ===== SMALL TABLET / LARGE PHONE (768px-1024px) - Fire Tablet ===== */
@media (max-width: 900px) and (min-width: 769px) {
  .overlay {
    padding: 10px;
    gap: 10px;
  }
  
  .right-panel {
    min-width: 220px !important;
  }
  
  .row-1 {
    height: 40%;
    min-height: 160px;
  }

  .clock-panel {
    flex: 0.3 !important; /* 30% */
  }
  
  .transactions-panel {
    flex: 0.7 !important; /* 70% */
  }
  
  /* Super compact clock */
  #clock {
    font-size: 22px !important;
    margin-bottom: 0 !important;
  }
  
  #date {
    font-size: 11px !important;
    opacity: 0.9 !important;
  }
  
  .clock-panel {
    padding: 10px !important;
    justify-content: center !important;
  }
  
  /* Maximize cards table space */
  .cards-table-container {
    max-height: calc(100% - 40px) !important;
  }
  
  .transactions-header {
    margin-bottom: 8px !important;
    padding-bottom: 6px !important;
  }
  
  .cards-table th {
    padding: 6px 8px !important;
    font-size: 11px !important;
  }
  
  .cards-table td {
    padding: 5px 8px !important;
    font-size: 11px !important;
  }
}
  .event-time-container {
    min-width: 32%;
  }
  
  .event-title {
    font-size: 12px;
  }
  
  .event-location {
    font-size: 10px;
    margin-left: 0.5%;
  }
  
  .weather-desc {
    display: none;
  }
  
  .weather-temp {
    margin-right: 8px;
  }
  
  #youtube-player-area {
    height: 140px !important;
  }
  
  #youtube-search-input {
    padding: 8px 10px;
    font-size: 12px;
  }
  
  #youtube-search-btn {
    padding: 0 10px;
    font-size: 14px;
  }
  
  .youtube-btn {
    padding: 6px 3px;
    font-size: 10px;
  }
  
  .cards-table th,
  .cards-table td {
    padding: 5px 7px;
    font-size: 11px;
  }
  
  #last-updated {
    font-size: 10px;
  }
}

@media (max-width: 600px) {
  .overlay {
    flex-direction: column;
    padding: 8px;
    gap: 8px;
    overflow-y: auto;
  }
  
  .left-panel, .right-panel {
    width: 100% !important;
    flex: none !important;
    min-width: 100% !important;
  }
  
  .right-panel {
    margin-left: 0 !important;
  }
  
  .row-1 {
    flex-direction: column;
    height: auto;
    min-height: auto;
    gap: 10px;
  }
  
  .clock-panel, .transactions-panel {
    width: 100%;
    min-height: 120px;
  }
  
  #clock {
    font-size: 28px;
  }
  
  #date {
    font-size: 15px;
  }
  
  .events-panel {
    min-height: 300px;
  }
  
  .event-item {
    padding: 6px 8px;
    flex-direction: column;
  }
  
  .event-time-container {
    min-width: 100%;
    margin-right: 0;
    margin-bottom: 6px;
    flex-direction: row;
    justify-content: space-between;
  }
  
  .event-time, .event-end-time {
    font-size: 12px;
  }
  
  .event-title {
    min-width: 100%;
    font-size: 13px;
  }
  
  .event-location {
    margin-left: 0.5%;
    font-size: 11px;
    margin-top: 6px;
  }
  
  .cards-table th,
  .cards-table td {
    padding: 4px 6px;
    font-size: 10px;
  }
  
  .cards-table .amount {
    font-size: 11px;
  }
  
  #last-updated {
    font-size: 9px;
  }
  
  #youtube-panel {
    display: none;
  }
  
  #weather-panel, #stock-panel {
    min-height: 150px;
  }
}
</style>
</head>
<body>
<div class="overlay">
  <!-- LEFT column: row 1 (clock + transactions) + row 2 (events) -->
  <div class="left-panel">
    <!-- Row 1: Clock + Transactions -->
    <div class="row-1">
      <!-- Clock Panel -->
      <div class="panel clock-panel">
        <div id="clock">--:-- --</div>
        <div id="date">Loading date‚Ä¶</div>
      </div>
      
      <!-- Transactions Panel -->
      <div class="panel transactions-panel">
<div class="transactions-header">
  <div class="transactions-title-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
      <div id="total-balance" style="font-weight: bold; font-size: 16px; color: #4CAF50;">Total: $0.00</div>
    </div>
    <div id="last-updated">Last updated: --</div>
  </div>
  <button id="sync-sheets-btn">üîÑSync</button>
</div>
        <div class="cards-table-container">
          <table class="cards-table" id="cards-table">
            <thead>
              <tr>
                <th>Card Issuer</th>
                <th style="text-align: right;">Open Balance</th>
              </tr>
            </thead>
            <tbody>
              <!-- Cards will be loaded dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Row 2: Events -->
    <div class="panel events-panel">
      <div id="auth-status">Initializing...</div>
      <button id="sign-in" disabled>Loading Google Sign-in...</button>
      <button id="enable-voice">Enable voice alerts</button>
      <div id="events-container">
        <div id="events"></div>
      </div>
    </div>
  </div>
  
  <!-- RIGHT column: weather + youtube + stock -->
  <div class="right-panel">
    <div class="panel" id="weather-panel">
      <div id="weather-current">Loading weather‚Ä¶</div>
      <div id="weather-forecast"></div>
      <div id="weather-hourly-detail"></div>
    </div>

    <div class="panel" id="youtube-panel">
        <div id="youtube-widget-container">
            <!-- Search Bar -->
            <div id="youtube-search-section">
                <input type="text" id="youtube-search-input" placeholder="Search Videos">
                <button id="youtube-search-btn" title="Search YouTube">üîç</button>
            </div>
            
            <!-- Video Player Area -->
            <div id="youtube-player-area">
                <div id="youtube-player"></div>
                <div id="youtube-video-info">
                    <div id="youtube-video-title">Select a video to play</div>
                    <div id="youtube-video-channel">Use search or quick buttons</div>
                </div>
            </div>
                  
            <!-- Search Results (Hidden initially) -->
            <div id="youtube-results-container" style="display: none;">
                <div id="youtube-results-header">
                    <span>Search Results</span>
                    <button id="youtube-close-results">‚úï Close</button>
                </div>
                <div id="youtube-results-list"></div>
            </div>
        </div>
    </div>

    <div class="panel" id="stock-panel">
      <div id="tradingview-widget" style="width:100%;height:100%;"></div>
    </div>
  </div>
</div>

<!-- YouTube Search Results Popup (add this anywhere in body) -->
<div id="youtube-popup-overlay"></div>
<div id="youtube-results-popup">
  <div id="youtube-results-popup-header">
    <span>üé¨ YouTube Search Results</span>
    <button id="youtube-close-popup">‚úï Close</button>
  </div>
  <div id="youtube-results-popup-list"></div>
</div>
<!-- ADD THIS POPUP HTML RIGHT HERE (before closing body tag) -->
<div id="youtube-popup-overlay"></div>
<div id="youtube-results-popup">
  <div id="youtube-results-popup-header">
    <span>üé¨ YouTube Search Results</span>
    <button id="youtube-close-popup">‚úï Close</button>
  </div>
  <div id="youtube-results-popup-list"></div>
</div>

<script>
// ===== CONFIGURATION =====
const CLIENT_ID = "703875968822-6ma5u7st5qm3eqgb1ktt9p52vs8knrb3.apps.googleusercontent.com";
const API_KEY = "AIzaSyCcx8q0nHP9DkA-M_KFyjFo-uLV-7TOrSE";
const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
const CALENDAR_ID = "family03331431524389313579@group.calendar.google.com";
const YOUTUBE_API_KEY = 'AIzaSyD_Nb4qiALrzYQWp7cQPMdOZV7pCz2UbcM'; // ‚Üê Replace with your actual key

const GOOGLE_SHEET_ID = '1tpGuEgRMghxo9vP1nvQ1wQkjw0zJqtcP1XLTUlLZmXY'; // From sheet URL: docs.google.com/spreadsheets/d/[THIS_IS_THE_ID]/edit
const SHEET_API_KEY = 'AIzaSyAX_u3NAIVdCBgaf9_b0kXly723b5DaIfo'; // Get from Google Cloud Console
const SHEET_NAME = 'Card Balances';
const SHEET_RANGE = 'A:E';
const SHEETS_SYNC_INTERVAL = 120 * 60 * 1000; // 2 minutes

// ===== GLOBAL VARIABLES =====
let tokenClient = null;
let calendarRefreshInterval = null;
let reminderCheckInterval = null;
let spokenEvents = new Set();
let voiceEnabled = false;
let voiceEnabledDate = null;
let weatherDailyData = null;
let weatherCurrentView = "daily";
let weatherSelectedDate = null;
let currentYouTubeVideo = null;

// ===== CLOCK =====
function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent = now.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
  document.getElementById("date").textContent = now.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric",
  });
}
setInterval(updateClock, 1000);
updateClock();

// ===== GOOGLE SHEETS CREDIT CARD MANAGEMENT =====
async function initCreditCardsSheets() {
  console.log("Initializing Google Sheets credit cards...");
  
  try {
    const sheetCards = await loadCardsFromSheets();
    
    if (sheetCards && sheetCards.length > 0) {
      const latestCards = getLatestCards(sheetCards);
      displayCardsTable(latestCards);
      updateLastUpdatedDisplay();
    } else {
      console.log("No data in Google Sheet, using defaults");
      displayCardsTable(DEFAULT_CARDS_SIMPLE);
      updateLastUpdatedDisplay();
    }
    
  } catch (error) {
    console.error("Google Sheets init failed:", error);
    const savedCards = localStorage.getItem('cardsLocalFallback');
    let cards = savedCards ? JSON.parse(savedCards) : DEFAULT_CARDS_SIMPLE;
    
    if (cards.length < 6) {
      cards = cards.concat(DEFAULT_CARDS_SIMPLE.slice(cards.length, 6));
    }
    
    displayCardsTable(cards);
    updateLastUpdatedDisplay();
  }
  
  setupSyncButton();
  addSyncStatusIndicator();
  startAutoSyncSheets();
}

function setupSyncButton() {
  const syncBtn = document.getElementById('sync-sheets-btn');
  if (!syncBtn) {
    console.error("Sync button not found!");
    return;
  }
  
  syncBtn.onclick = async () => {
    const originalText = syncBtn.innerHTML;
    syncBtn.innerHTML = 'üîÑ Syncing...';
    syncBtn.disabled = true;
    
    try {
      const cards = await loadCardsFromSheets(true);
      
      if (!cards || cards.length === 0) {
        return;
      }
      
      const latestCards = getLatestCards(cards);
      displayCardsTable(latestCards);
      updateLastUpdatedDisplay();
      
    } catch (error) {
      console.error("Sync failed:", error);
      
      const cached = getCachedCards();
      if (cached) {
        const latestCards = getLatestCards(cached);
        displayCardsTable(latestCards);
      }
    } finally {
      syncBtn.innerHTML = originalText;
      syncBtn.disabled = false;
    }
  };
}

async function loadCardsFromSheets(forceRefresh = false) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${SHEET_NAME}!${SHEET_RANGE}?key=${SHEET_API_KEY}`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Google Sheets API error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.values || data.values.length < 2) {
      return null;
    }
    
    const headers = data.values[0];
    const rows = data.values.slice(1);
    
    const cards = rows.map(row => {
      const card = {};
      headers.forEach((header, index) => {
        const key = header.toLowerCase().replace(/ /g, '_');
        card[key] = row[index] || '';
      });
      
      card.balance = parseFloat(card.balance) || 0;
      
      return card;
    });
    
    cacheCards(cards);
    localStorage.setItem('cardsLastSync', Date.now().toString());
    
    return cards;
    
  } catch (error) {
    console.error("Failed to load from Google Sheets:", error);
    
    const cached = getCachedCards();
    if (cached) {
      console.log("Using cached card data");
      return cached;
    }
    
    throw error;
  }
}

function getLatestCards(allCards) {
  const cardMap = new Map();
  
  allCards.forEach(card => {
    const issuerKey = (card.card_issuer || card.issuer || '').toLowerCase().trim();
    if (!issuerKey) {
      console.warn("Card missing issuer:", card);
      return;
    }
    
    let currentTime = 0;
    if (card.last_updated) {
      currentTime = new Date(card.last_updated).getTime();
    } else if (card.timestamp) {
      currentTime = new Date(card.timestamp).getTime();
    } else {
      currentTime = Date.now();
    }
    
    const existing = cardMap.get(issuerKey);
    const existingTime = existing ? (new Date(existing.last_updated || existing.timestamp || 0).getTime()) : 0;
    
    if (!existing || currentTime > existingTime) {
      cardMap.set(issuerKey, {
        issuer: card.card_issuer || card.issuer || issuerKey,
        balance: card.balance || 0,
        last_updated: card.last_updated || new Date(currentTime).toISOString()
      });
    }
  });
  
  const latestCards = Array.from(cardMap.values())
    .sort((a, b) => a.issuer.localeCompare(b.issuer));
  
  return latestCards;
}

function displayCardsTable(cards) {
  const tableBody = document.querySelector('#cards-table tbody');
  let html = '';
  let total = 0;
  
  // Calculate total first
  cards.forEach(card => {
    total += card.balance || 0;
  });
  
  // Update the total display at the top
  const formattedTotal = total.toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  });
  
  // Determine color for total (green if zero, yellow if low, red if high)
  let totalColor = '#4CAF50'; // green for zero
  if (total > 0) {
    totalColor = total < 1000 ? '#FF9800' : '#F44336'; // yellow for <1000, red for >=1000
  }
  
  document.getElementById('total-balance').innerHTML = 
    `<span style="color: ${totalColor}; font-weight: 700;">Total: ${formattedTotal}</span>`;
  
  // Now create the table rows
  cards.forEach(card => {
    const issuer = card.card_issuer || card.issuer || 'Unknown Card';
    const balance = card.balance || 0;
    
    // Format individual balance
    const formattedBalance = balance.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 2
    });
    
    // Determine color for individual balance
    const balanceColor = balance === 0 ? '#4CAF50' : (balance < 1000 ? '#FF9800' : '#F44336');
    
    html += `
      <tr>
        <td>${issuer}</td>
        <td class="amount" style="color: ${balanceColor}; font-weight: ${balance > 0 ? '600' : 'normal'}">
          ${formattedBalance}
        </td>
      </tr>
    `;
  });
  
  // Remove the total row since we're showing it at the top
  tableBody.innerHTML = html;
}

function cacheCards(cards) {
  localStorage.setItem('cardsSheetsCache', JSON.stringify({
    data: cards,
    timestamp: Date.now()
  }));
}

function getCachedCards() {
  const cached = localStorage.getItem('cardsSheetsCache');
  if (!cached) return null;
  
  try {
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < 2 * 60 * 60 * 1000) {
      return data;
    }
  } catch (e) {
    console.error("Error reading cache:", e);
  }
  
  return null;
}

function updateLastUpdatedDisplay() {
  const lastUpdatedEl = document.getElementById('last-updated');
  if (!lastUpdatedEl) return;
  
  const lastSync = localStorage.getItem('cardsLastSync');
  
  if (lastSync) {
    const syncTime = new Date(parseInt(lastSync));
    const now = new Date();
    const diffMs = now - syncTime;
    
    let timeString;
    if (diffMs < 60000) {
      timeString = "just now";
    } else if (diffMs < 3600000) {
      const mins = Math.floor(diffMs / 60000);
      timeString = `${mins}m ago`;
    } else if (diffMs < 86400000) {
      const hours = Math.floor(diffMs / 3600000);
      timeString = `${hours}h ago`;
    } else {
      const days = Math.floor(diffMs / 86400000);
      timeString = `${days}d ago`;
    }
    
    const formattedTime = syncTime.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    lastUpdatedEl.innerHTML = `
      <div style="font-size: 9px; display: flex; align-items: center; gap: 4px;">
        <span style="color: #34A853;">‚úÖ Synced with Google Sheets</span>
        <span style="opacity: 0.7; font-size: 8px;">${formattedTime}</span>
      </div>
    `;
  } else {
    const localUpdate = localStorage.getItem('cardsLocalFallbackTime');
    if (localUpdate) {
      const updateTime = new Date(parseInt(localUpdate));
      lastUpdatedEl.innerHTML = `
        <div style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
          <span style="color: #FBBC05;">‚ö† Local data only</span>
          <span style="opacity: 0.7; font-size: 10px;">
            ${updateTime.toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            })}
          </span>
        </div>
      `;
    } else {
      lastUpdatedEl.textContent = "Last updated: Never";
    }
  }
}

function addSyncStatusIndicator() {
  const header = document.querySelector('.transactions-header');
  if (!header) return;
  
  if (header.querySelector('#auto-sync-indicator')) {
    return;
  }
  
  const indicator = document.createElement('div');
  indicator.id = 'auto-sync-indicator';
  indicator.innerHTML = 'üîÑAuto-sync';
  indicator.style.cssText = `
    font-size: 7px;
    color: #34A853;
    opacity: 0.7;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  `;
  
  const titleContainer = document.querySelector('.transactions-title-container');
  if (titleContainer) {
    titleContainer.appendChild(indicator);
  }
}

function startAutoSyncSheets() {
  console.log(`Starting Google Sheets auto-sync`);
  
  autoSyncSheets();
  const autoSyncInterval = setInterval(autoSyncSheets, SHEETS_SYNC_INTERVAL);
  window.sheetsAutoSyncInterval = autoSyncInterval;
  
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      autoSyncSheets();
    }
  });
}

async function autoSyncSheets() {
  try {
    const cards = await loadCardsFromSheets();
    
    if (cards && cards.length > 0) {
      const latestCards = getLatestCards(cards);
      displayCardsTable(latestCards);
      updateLastUpdatedDisplay();
    }
  } catch (error) {
    console.log("Auto-sync failed:", error.message);
  }
}

// ===== YOUTUBE INTEGRATION =====
function initYouTube() {
    console.log("Initializing YouTube with API search...");
    
    document.getElementById('youtube-search-btn').onclick = performYouTubeSearch;
    
    document.getElementById('youtube-search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performYouTubeSearch();
        }
    });
    
    document.querySelectorAll('.youtube-btn').forEach(button => {
        button.onclick = function() {
            const videoId = this.getAttribute('data-id');
            const title = this.getAttribute('data-title');
            const channel = this.getAttribute('data-channel');
            playYouTubeVideo(videoId, title, channel);
        };
    });
    
    document.getElementById('youtube-close-results').onclick = function() {
        document.getElementById('youtube-results-container').style.display = 'none';
    };
    
    playYouTubeVideo('7wtfhZwyrcc', 'Imagine Dragons', 'Believer');
}

async function performYouTubeSearch() {
  const query = document.getElementById('youtube-search-input').value.trim();
  if (!query) {
    alert('Please enter a search term');
    return;
  }
  
  console.log("Searching YouTube for:", query);
  
  // 1. CREATE SIMPLE POPUP DYNAMICALLY
  let popup = document.getElementById('youtube-simple-popup');
  let overlay = document.getElementById('youtube-simple-overlay');
  
  // Remove any existing popups first
  if (popup) popup.remove();
  if (overlay) overlay.remove();
  
  // Create overlay
  overlay = document.createElement('div');
  overlay.id = 'youtube-simple-overlay';
  overlay.style.cssText = `
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(0,0,0,0.9) !important;
    z-index: 9998 !important;
    display: block !important;
  `;
  
  // Create popup container
  popup = document.createElement('div');
  popup.id = 'youtube-simple-popup';
  popup.style.cssText = `
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90% !important;
    max-width: 700px !important;
    height: 80vh !important;
    background: #111 !important;
    border: 3px solid #ff0000 !important;
    border-radius: 15px !important;
    z-index: 9999 !important;
    display: block !important;
    overflow: hidden !important;
    box-shadow: 0 0 50px rgba(255,0,0,0.3) !important;
  `;
  
  // Create popup content
  popup.innerHTML = `
    <div style="
      background: #222;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #ff0000;
    ">
      <div style="font-size: 18px; font-weight: bold; color: white;">
        üîç Search Results for: <span style="color: #ff4444;">"${query}"</span>
      </div>
      <button id="youtube-simple-close" style="
        background: #ff0000;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      ">‚úï Close</button>
    </div>
    <div id="youtube-simple-results" style="
      padding: 20px;
      height: calc(80vh - 70px);
      overflow-y: auto;
    ">
      <div style="text-align: center; padding: 40px; color: white; font-size: 16px;">
        ‚è≥ Searching YouTube...
      </div>
    </div>
  `;
  
  // Add to page
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  // Add close functionality
  document.getElementById('youtube-simple-close').onclick = function() {
    overlay.remove();
    popup.remove();
  };
  
  // Close when clicking overlay
  overlay.onclick = function() {
    overlay.remove();
    popup.remove();
  };
  
  // Close with Escape key
  const closeOnEscape = function(e) {
    if (e.key === 'Escape') {
      overlay.remove();
      popup.remove();
      document.removeEventListener('keydown', closeOnEscape);
    }
  };
  document.addEventListener('keydown', closeOnEscape);
  
  // 2. PERFORM THE SEARCH
  try {
    const response = await fetch(
      `https://www.googleapis.com/youtube/v3/search?` +
      `part=snippet&` +
      `maxResults=12&` +
      `q=${encodeURIComponent(query)}&` +
      `type=video&` +
      `videoEmbeddable=true&` +
      `key=${YOUTUBE_API_KEY}`
    );
    
    if (!response.ok) {
      throw new Error(`YouTube API error: ${response.status}`);
    }
    
    const data = await response.json();
    const resultsDiv = document.getElementById('youtube-simple-results');
    
    if (!data.items || data.items.length === 0) {
      resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: white;">
          <div style="font-size: 18px; margin-bottom: 20px;">‚ùå No videos found for "${query}"</div>
          <button onclick="document.getElementById('youtube-simple-overlay')?.remove(); document.getElementById('youtube-simple-popup')?.remove();" style="
            padding: 10px 20px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
          ">Close</button>
        </div>
      `;
      return;
    }
    
    // Display results
    let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">';
    
    data.items.forEach(video => {
      const videoId = video.id.videoId;
      const title = video.snippet.title;
      const channel = video.snippet.channelTitle;
      const thumbnail = video.snippet.thumbnails.medium ? 
                        video.snippet.thumbnails.medium.url : 
                        video.snippet.thumbnails.default.url;
      
      // Clean text for HTML
      const cleanTitle = title.replace(/['"<>]/g, '').substring(0, 50);
      const cleanChannel = channel.replace(/['"<>]/g, '');
      
      html += `
        <div style="
          width: 200px;
          background: #222;
          border-radius: 10px;
          overflow: hidden;
          cursor: pointer;
          transition: transform 0.3s;
          border: 1px solid #333;
        " onclick="
          playYouTubeVideo('${videoId}', '${cleanTitle}', '${cleanChannel}');
          document.getElementById('youtube-simple-overlay')?.remove();
          document.getElementById('youtube-simple-popup')?.remove();
        " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#ff0000';"
        onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='#333';">
          <img src="${thumbnail}" style="width: 100%; height: 120px; object-fit: cover;">
          <div style="padding: 12px;">
            <div style="font-weight: bold; font-size: 13px; color: white; margin-bottom: 5px; height: 36px; overflow: hidden;">
              ${cleanTitle}${title.length > 50 ? '...' : ''}
            </div>
            <div style="font-size: 11px; color: #aaa; margin-bottom: 8px;">
              ${cleanChannel}
            </div>
            <div style="font-size: 10px; color: #ff4444; text-align: center; padding: 3px; background: rgba(255,0,0,0.1); border-radius: 3px;">
              ‚ñ∂Ô∏è Click to Play
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    
  } catch (error) {
    console.error("Search failed:", error);
    const resultsDiv = document.getElementById('youtube-simple-results');
    resultsDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: white;">
        <div style="font-size: 18px; margin-bottom: 10px; color: #ff4444;">‚ùå Search Failed</div>
        <div style="font-size: 14px; margin-bottom: 20px; opacity: 0.8;">${error.message}</div>
        <button onclick="document.getElementById('youtube-simple-overlay')?.remove(); document.getElementById('youtube-simple-popup')?.remove();" style="
          padding: 10px 20px;
          background: #ff0000;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
        ">Close</button>
      </div>
    `;
  }
}

function displaySearchResults(videos) {
  const popupList = document.getElementById('youtube-results-popup-list');
  let html = '';
  
  videos.forEach(video => {
    const videoId = video.id.videoId;
    const title = video.snippet.title;
    const channel = video.snippet.channelTitle;
    const thumbnail = video.snippet.thumbnails.medium ? 
                      video.snippet.thumbnails.medium.url : 
                      video.snippet.thumbnails.default.url;
    const published = new Date(video.snippet.publishedAt).toLocaleDateString();
    
    // Clean up title for HTML
    const cleanTitle = title.replace(/['"<>]/g, '');
    const cleanChannel = channel.replace(/['"<>]/g, '');
    
    // Get video duration if available (requires additional API call)
    const duration = video.contentDetails ? formatDuration(video.contentDetails.duration) : '';
    
    html += `
      <div class="youtube-popup-result-item" onclick="selectPopupResult('${videoId}', '${cleanTitle}', '${cleanChannel}')">
        <img class="youtube-popup-result-thumb" src="${thumbnail}" alt="${cleanTitle}">
        <div class="youtube-popup-result-info">
          <div class="youtube-popup-result-title">${cleanTitle}</div>
          <div class="youtube-popup-result-channel">${channel}</div>
          <div style="font-size: 11px; opacity: 0.6; margin-top: 2px;">Published: ${published}</div>
          ${duration ? `<div class="youtube-popup-result-duration">‚è±Ô∏è ${duration}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  popupList.innerHTML = html;
  
  // Show the popup
  showYoutubePopup();
}

// Helper function to format duration (if you want to add duration)
function formatDuration(duration) {
  if (!duration) return '';
  
  // Convert ISO 8601 duration to readable format
  const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
  if (!match) return '';
  
  const hours = (match[1] || '').replace('H', '');
  const minutes = (match[2] || '').replace('M', '');
  const seconds = (match[3] || '').replace('S', '');
  
  let result = '';
  if (hours) result += `${hours}:`;
  if (minutes) result += `${minutes.padStart(2, '0')}:`;
  if (seconds) result += `${seconds.padStart(2, '0')}`;
  
  return result;
}

// Popup control functions
function showYoutubePopup() {
  const overlay = document.getElementById('youtube-popup-overlay');
  const popup = document.getElementById('youtube-results-popup');
  
  overlay.style.display = 'block';
  popup.style.display = 'block';
  
  // Add close handlers
  overlay.onclick = closeYoutubePopup;
  document.getElementById('youtube-close-popup').onclick = closeYoutubePopup;
  
  // Close with Escape key
  document.addEventListener('keydown', handlePopupEscape);
}

function closeYoutubePopup() {
  const overlay = document.getElementById('youtube-popup-overlay');
  const popup = document.getElementById('youtube-results-popup');
  
  overlay.style.display = 'none';
  popup.style.display = 'none';
  
  // Remove event listener
  document.removeEventListener('keydown', handlePopupEscape);
}

function handlePopupEscape(event) {
  if (event.key === 'Escape') {
    closeYoutubePopup();
  }
}

function selectPopupResult(videoId, title, channel) {
  console.log("Selected from popup:", videoId);
  
  playYouTubeVideo(videoId, title, channel);
  closeYoutubePopup();
  
  // Clear search input
  document.getElementById('youtube-search-input').value = '';
}

function selectSearchResult(videoId, title, channel) {
    console.log("Selected from search:", videoId);
    
    playYouTubeVideo(videoId, title, channel);
    
    document.getElementById('youtube-results-container').style.display = 'none';
    document.getElementById('youtube-search-input').value = '';
}

function playYouTubeVideo(videoId, title, channel) {
    console.log("Playing video:", videoId);
    
    currentYouTubeVideo = { id: videoId, title: title, channel: channel };
    
    updateVideoInfo(title, channel);
    
    const playerDiv = document.getElementById('youtube-player');
    
    playerDiv.innerHTML = `
        <iframe
            width="100%"
            height="100%"
            src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&controls=1"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
        </iframe>
    `;
    
    setTimeout(() => {
        const iframe = playerDiv.querySelector('iframe');
        if (iframe) {
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&controls=1`;
        }
    }, 500);
}

function updateVideoInfo(title, channel) {
    document.getElementById('youtube-video-title').textContent = title;
    document.getElementById('youtube-video-channel').textContent = channel;
}

// ===== GOOGLE CALENDAR AUTHENTICATION =====
function initGoogleApi() {
  console.log("Initializing Google API...");
  
  if (!window.gapi) {
    console.error("Google API library not loaded");
    document.getElementById("auth-status").textContent = "Error: Google API failed to load";
    return;
  }
  
  gapi.load('client', async () => {
    try {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
      });
      console.log("Google API client initialized");
      
      // First, try to restore any saved session before initializing identity
      const restored = await tryRestoreSession();
      if (!restored) {
        initGoogleIdentity();
      }
      
    } catch (error) {
      console.error("Failed to initialize Google API:", error);
      document.getElementById("auth-status").textContent = "Error initializing Google API";
    }
  });
}

async function tryRestoreSession() {
  console.log("Attempting to restore session...");
  
  // First check localStorage for saved token
  const savedToken = localStorage.getItem('google_auth_token_improved');
  if (!savedToken) {
    console.log("No saved token found");
    return false;
  }
  
  try {
    const token = JSON.parse(savedToken);
    const now = Date.now();
    
    // Check if token is expired or will expire soon
    if (token.expires_at && now > token.expires_at) {
      console.log("Saved token expired");
      localStorage.removeItem('google_auth_token_improved');
      return false;
    }
    
    // If token expires in less than 5 minutes, don't restore (force fresh login)
    const timeUntilExpiry = token.expires_at - now;
    if (timeUntilExpiry < 5 * 60 * 1000) {
      console.log("Token expires soon, not restoring");
      localStorage.removeItem('google_auth_token_improved');
      return false;
    }
    
    // Set the token in gapi
    gapi.client.setToken(token);
    
    // Verify the token is still valid by making a simple API call
    try {
      await gapi.client.calendar.calendarList.list({
        maxResults: 1
      });
      
      console.log("‚úÖ Session restored successfully!");
      updateAuthUI(true);
      loadCalendarEvents();
      startAutoRefresh();
      
      return true;
      
    } catch (apiError) {
      console.log("Token validation failed:", apiError);
      localStorage.removeItem('google_auth_token_improved');
      gapi.client.setToken(null);
      return false;
    }
    
  } catch (e) {
    console.error("Failed to restore session:", e);
    localStorage.removeItem('google_auth_token_improved');
    return false;
  }
}

function initGoogleIdentity() {
  console.log("Initializing Google Identity Services...");
  
  if (!window.google || !window.google.accounts) {
    console.error("Google Identity Services not loaded");
    document.getElementById("auth-status").textContent = "Error: Google Sign-in failed to load";
    return;
  }
  
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      console.log("Authentication callback received");
      
      if (tokenResponse && tokenResponse.access_token) {
        console.log("Access token received, expiry:", tokenResponse.expires_in, "seconds");
        
        // Save token with improved persistence
        saveTokenImproved(tokenResponse);
        
        // Set token in gapi with issue time
        tokenResponse.issue_time = Date.now();
        gapi.client.setToken(tokenResponse);
        
        // Update UI and load events
        updateAuthUI(true);
        loadCalendarEvents();
        startAutoRefresh();
        
        console.log("Sign-in successful, token saved");
      } else if (tokenResponse && tokenResponse.error) {
        console.error("Authentication error:", tokenResponse.error);
        document.getElementById("auth-status").textContent = "Sign-in error: " + tokenResponse.error;
      } else {
        console.log("Authentication cancelled");
        document.getElementById("auth-status").textContent = "Sign-in cancelled";
      }
    },
    error_callback: (error) => {
      console.error("Authentication error callback:", error);
      document.getElementById("auth-status").textContent = "Sign-in error occurred";
    }
  });
  
  console.log("Google Identity Services initialized");
  setupAuthButton(); 
}

function stopAutoRefresh() {
  if (calendarRefreshInterval) {
    clearInterval(calendarRefreshInterval);
    calendarRefreshInterval = null;
    console.log("Stopped auto-refresh");
  }
  
  // Also stop the token monitor if it exists
  if (window.tokenMonitorInterval) {
    clearInterval(window.tokenMonitorInterval);
    window.tokenMonitorInterval = null;
    console.log("Stopped token monitor");
  }
}

function setupAuthButton() {
  const signInBtn = document.getElementById("sign-in");
  const authStatus = document.getElementById("auth-status");
  
  const token = gapi.client.getToken();
  
  if (token && token.access_token) {
    // Already signed in - hide button and status
    signInBtn.style.display = "none";
    authStatus.textContent = "";
    // Don't load events here - they're already loaded by tryRestoreSession
  } else {
    // Not signed in - show button
    signInBtn.style.display = "inline-block";
    signInBtn.textContent = "Sign in with Google";
    signInBtn.disabled = false;
    authStatus.textContent = "Ready to sign in";
  }
  
  signInBtn.onclick = handleAuthClick;
}

function handleAuthClick() {
  const token = gapi.client.getToken();
  
  if (token && token.access_token) {
    handleSignOut();
  } else {
    handleSignIn();
  }
}

function handleSignIn() {
  console.log("Starting sign in...");
  
  if (!tokenClient) {
    document.getElementById("auth-status").textContent = "Sign-in not ready. Please refresh.";
    return;
  }
  
  document.getElementById("auth-status").textContent = "Opening Google sign-in...";
  tokenClient.requestAccessToken();
}

function handleSignOut() {
  console.log("Signing out...");
  
  const token = gapi.client.getToken();
  if (token) {
    try {
      google.accounts.oauth2.revoke(token.access_token, () => {
        console.log("Access token revoked");
      });
    } catch (e) {
      console.log("Token revoke error:", e);
    }
  }
  
  gapi.client.setToken(null);
  
  // STOP ALL INTERVALS
  stopAutoRefresh();
  stopVoiceReminders();
  
  // Clear ALL token storage
  localStorage.removeItem('google_auth_token_improved');
  localStorage.removeItem('googleToken');
  localStorage.removeItem('tokenSavedAt');
  localStorage.removeItem('calendarEvents');
  localStorage.removeItem('eventsLastUpdated');
  localStorage.removeItem('voiceEnabledDate');
  
  document.getElementById("events").innerHTML = "";
  
  // Show the sign-in button again
  const signInBtn = document.getElementById("sign-in");
  signInBtn.style.display = "inline-block";
  signInBtn.textContent = "Sign in with Google";
  document.getElementById("auth-status").textContent = "Signed out. Click to sign in again.";
  document.getElementById("enable-voice").style.display = "inline-block";
  document.getElementById("enable-voice").textContent = "Enable voice alerts";
  
  spokenEvents.clear();
  voiceEnabled = false;
  voiceEnabledDate = null;
  
  console.log("Sign-out complete");
}

function updateAuthUI(isSignedIn) {
  const signInBtn = document.getElementById("sign-in");
  const authStatus = document.getElementById("auth-status");
  
  if (isSignedIn) {
    // Hide the sign-in button and clear the auth status text
    signInBtn.style.display = "none";
    authStatus.textContent = ""; // Clear the text
  } else {
    // Show the sign-in button and status
    signInBtn.style.display = "inline-block";
    signInBtn.textContent = "Sign in with Google";
    authStatus.textContent = "Ready to sign in";
  }
}

// ===== IMPROVED TOKEN PERSISTENCE =====
const TOKEN_KEY = 'google_auth_token_improved';

function saveTokenImproved(token) {
  if (token && token.access_token) {
    token.saved_at = Date.now();
    token.expires_at = Date.now() + (token.expires_in * 1000);
    localStorage.setItem(TOKEN_KEY, JSON.stringify(token));
    console.log("Token saved with expiry:", new Date(token.expires_at).toLocaleTimeString());
  }
}

// ===== CALENDAR EVENTS =====
async function loadCalendarEvents() {
  console.log("Loading calendar events...");
  
  try {
    const now = new Date();
    const timeMin = now.toISOString();
    const timeMax = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

    const response = await gapi.client.calendar.events.list({
      calendarId: CALENDAR_ID,
      timeMin,
      timeMax,
      showDeleted: false,
      singleEvents: true,
      orderBy: "startTime",
      maxResults: 100,
    });
    
    const events = response.result.items || [];
    console.log(`Loaded ${events.length} events`);
    
    if (events.length === 0) {
      document.getElementById("events").textContent = "No upcoming events found.";
      return;
    }
    
    renderEvents(events);
    
    localStorage.setItem('calendarEvents', JSON.stringify(events));
    localStorage.setItem('eventsLastUpdated', Date.now());
    
    checkVoiceEnabledForToday();
    
    if (voiceEnabled) {
      scheduleVoiceReminders(events);
    }
    
  } catch (error) {
    console.error("Error loading calendar:", error);
    
    // Handle token errors gracefully
    if (error.status === 401 || error.status === 403) {
      console.log("Token expired or invalid, signing out...");
      
      // Don't sign out immediately, try to use saved token first
      const savedToken = localStorage.getItem(TOKEN_KEY);
      if (savedToken) {
        try {
          const token = JSON.parse(savedToken);
          const now = Date.now();
          
          // Check if saved token is still valid
          if (token.expires_at && now < token.expires_at) {
            console.log("Attempting to use saved token...");
            gapi.client.setToken(token);
            // Retry once
            setTimeout(loadCalendarEvents, 1000);
            return;
          }
        } catch (e) {
          console.error("Error parsing saved token:", e);
        }
      }
      
      // If we get here, we need to sign out
      document.getElementById("auth-status").textContent = "Session expired. Please sign in again.";
      setTimeout(() => {
        updateAuthUI(false);
      }, 2000);
    } else {
      document.getElementById("auth-status").textContent = "Error loading calendar";
    }
  }
}

function renderEvents(events) {
  const container = document.getElementById("events");
  container.innerHTML = "";

  const eventsByDate = {};
  
  events.forEach(event => {
    const start = event.start.dateTime || event.start.date;
    const date = new Date(start);
    const dateKey = date.toDateString();
    
    if (!eventsByDate[dateKey]) {
      eventsByDate[dateKey] = [];
    }
    
    eventsByDate[dateKey].push(event);
  });

  Object.keys(eventsByDate)
    .sort((a, b) => new Date(a) - new Date(b))
    .forEach(dateKey => {
      const dayHeader = document.createElement("div");
      dayHeader.className = "event-day";
      dayHeader.textContent = dateKey;
      container.appendChild(dayHeader);

      eventsByDate[dateKey]
        .sort((a, b) => new Date(a.start.dateTime || a.start.date) - new Date(b.start.dateTime || b.start.date))
        .forEach(event => {
          const eventItem = document.createElement("div");
          eventItem.className = "event-item";

          const isAllDay = !!event.start.date;
          const startTime = event.start.dateTime ? new Date(event.start.dateTime) : null;
          const endTime = event.end.dateTime ? new Date(event.end.dateTime) : null;
          
          const timeContainer = document.createElement("div");
          timeContainer.className = "event-time-container";
          
          const timeSpan = document.createElement("div");
          timeSpan.className = "event-time";
          
          if (isAllDay) {
            timeSpan.textContent = "All day";
          } else if (startTime) {
            timeSpan.textContent = startTime.toLocaleTimeString([], {
              hour: "numeric",
              minute: "2-digit",
              hour12: true,
            });
          } else {
            timeSpan.textContent = "Time TBD";
          }
          
          timeContainer.appendChild(timeSpan);
          
          if (endTime && !isAllDay) {
            const endTimeSpan = document.createElement("div");
            endTimeSpan.className = "event-end-time";
            endTimeSpan.textContent = endTime.toLocaleTimeString([], {
              hour: "numeric",
              minute: "2-digit",
              hour12: true,
            });
            timeContainer.appendChild(endTimeSpan);
          }
          
          const rightCol = document.createElement("div");
          rightCol.className = "event-right";
          
          const titleSpan = document.createElement("div");
          titleSpan.className = "event-title";
          titleSpan.textContent = event.summary || "(No title)";
          rightCol.appendChild(titleSpan);
          
          const metaRow = document.createElement("div");
          metaRow.className = "event-meta-row";
                   
          if (event.location) {
            const locationDiv = document.createElement("div");
            locationDiv.className = "event-location";
            locationDiv.textContent = event.location;
            metaRow.appendChild(locationDiv);
          }
          
          rightCol.appendChild(metaRow);
          
          eventItem.appendChild(timeContainer);
          eventItem.appendChild(rightCol);          
          container.appendChild(eventItem);
        });
    });
}

// ===== AUTO REFRESH =====
function startAutoRefresh() {
  console.log("Starting auto-refresh (every 30 minutes)");
  
  // Clear any existing interval first
  stopAutoRefresh();
  
  // Load events immediately
  loadCalendarEvents();
  
  // Set up the interval
  calendarRefreshInterval = setInterval(() => {
    console.log("Auto-refreshing calendar events...");
    loadCalendarEvents();
  }, 30 * 60 * 1000); // 30 minutes
  
  // Start a gentle token monitor (only for page visibility changes)
  startGentleTokenMonitor();
}

// ===== GENTLE TOKEN MONITOR =====
function startGentleTokenMonitor() {
  console.log("Starting gentle token monitor...");
  
  // Clear any existing monitor
  if (window.tokenMonitorInterval) {
    clearInterval(window.tokenMonitorInterval);
  }
  
  // Only monitor on page visibility changes
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      console.log("Page became visible, checking token...");
      checkTokenOnVisibility();
    }
  });
  
  // Also check every 2 hours (instead of every 5 minutes)
  window.tokenMonitorInterval = setInterval(() => {
    checkTokenQuietly();
  }, 2 * 60 * 60 * 1000); // 2 hours
}

function checkTokenOnVisibility() {
  const token = gapi.client.getToken();
  
  if (!token || !token.access_token) {
    console.log("No active token, checking saved token...");
    const savedToken = localStorage.getItem(TOKEN_KEY);
    
    if (savedToken) {
      try {
        const parsedToken = JSON.parse(savedToken);
        const now = Date.now();
        
        // Only restore if token has more than 10 minutes left
        if (parsedToken.expires_at && (parsedToken.expires_at - now) > 10 * 60 * 1000) {
          console.log("Restoring token from storage");
          gapi.client.setToken(parsedToken);
        }
      } catch (e) {
        console.error("Error checking saved token:", e);
      }
    }
  }
}

function checkTokenQuietly() {
  const token = gapi.client.getToken();
  
  if (!token || !token.access_token) {
    console.log("No active token in quiet check");
    return;
  }
  
  // Check if token will expire in the next 30 minutes
  const now = Date.now();
  const tokenAge = now - (token.issue_time || now);
  const expiresIn = (token.expires_in || 3600) * 1000;
  const timeUntilExpiry = expiresIn - tokenAge;
  
  console.log(`Token expires in ${Math.round(timeUntilExpiry / 60000)} minutes`);
  
  // If token expires in less than 30 minutes, gently prompt user
  if (timeUntilExpiry < 30 * 60 * 1000) {
    console.log("Token expiring soon, showing gentle reminder");
    document.getElementById("auth-status").textContent = "Session will expire soon. Please refresh the page.";
  }
}

// ===== VOICE ALERTS =====
function setupVoiceAlertsButton() {
  const voiceBtn = document.getElementById("enable-voice");
  if (!voiceBtn) return;
  
  voiceBtn.onclick = function() {
    console.log("Enable voice alerts button clicked");
    
    const savedEvents = localStorage.getItem('calendarEvents');
    if (!savedEvents) {
      console.error("No events found in localStorage");
      document.getElementById("auth-status").textContent = "No events to enable alerts for";
      return;
    }
    
    try {
      const events = JSON.parse(savedEvents);
      console.log(`Enabling voice alerts for ${events.length} events`);
      
      scheduleVoiceReminders(events);
      voiceBtn.style.display = "none";
      document.getElementById("auth-status").textContent = "Voice alerts enabled!";
      
    } catch (error) {
      console.error("Error parsing events:", error);
      document.getElementById("auth-status").textContent = "Error enabling voice alerts";
    }
  };
  
  console.log("Voice alerts button setup complete");
}

// ===== VOICE REMINDERS =====
function checkVoiceEnabledForToday() {
  const savedDate = localStorage.getItem('voiceEnabledDate');
  const today = new Date().toDateString();
  
  if (savedDate === today) {
    voiceEnabled = true;
    voiceEnabledDate = today;
    document.getElementById("enable-voice").style.display = "none";
    console.log("Voice alerts already enabled for today");
  } else {
    voiceEnabled = false;
    voiceEnabledDate = null;
    document.getElementById("enable-voice").style.display = "inline-block";
    document.getElementById("enable-voice").textContent = "Enable voice alerts";
  }
}

function scheduleVoiceReminders(events) {
  console.log("Scheduling voice reminders for", events.length, "events");
  
  if (!("speechSynthesis" in window)) {
    alert("Your browser doesn't support voice synthesis");
    return;
  }
  
  const today = new Date().toDateString();
  localStorage.setItem('voiceEnabledDate', today);
  voiceEnabled = true;
  voiceEnabledDate = today;
  
  document.getElementById("enable-voice").style.display = "none";
  
  if (reminderCheckInterval) {
    clearInterval(reminderCheckInterval);
    spokenEvents.clear();
  }
  
  reminderCheckInterval = setInterval(() => checkReminders(events), 10000);
  checkReminders(events);
}

function checkReminders(events) {
  const now = new Date();
  const nowMs = now.getTime();
  
  events.forEach(event => {
    if (!event.start || !event.start.dateTime) return;
    
    const eventStart = new Date(event.start.dateTime);
    const eventStartMs = eventStart.getTime();
    const eventId = event.id || event.summary;
    const minutesUntilEvent = (eventStartMs - nowMs) / (60 * 1000);
    
    if (minutesUntilEvent <= 30 && minutesUntilEvent > 29.5) {
      const reminderKey = `${eventId}_30min`;
      if (!spokenEvents.has(reminderKey)) {
        console.log(`Triggering 30-min reminder for: ${event.summary}`);
        prespeakReminder(event, 30);
        spokenEvents.add(reminderKey);
      }
    }
    
    if (minutesUntilEvent <= 15 && minutesUntilEvent > 14.5) {
      const reminderKey = `${eventId}_15min`;
      if (!spokenEvents.has(reminderKey)) {
        console.log(`Triggering 15-min reminder for: ${event.summary}`);
        prespeakReminder(event, 15);
        spokenEvents.add(reminderKey);
      }
    }

    if (minutesUntilEvent <= -15 && minutesUntilExpiry > -15.5) {
      const reminderKey = `${eventId}_15min`;
      if (!spokenEvents.has(reminderKey)) {
        console.log(`Triggering 15-min post reminder for: ${event.summary}`);
        postspeakReminder(event, 15);
        spokenEvents.add(reminderKey);
      }
    }
  });
}

function prespeakReminder(event, minutesBefore) {
  console.log(`Speaking ${minutesBefore}-min reminder:`, event.summary);
  const message = `Hey Spade family you have got: "${event.summary || "Event"}" starts in ${minutesBefore} minutes.`;
  const utterance = new SpeechSynthesisUtterance(message);
  utterance.rate = 0.8;
  utterance.pitch = 0.9;
  utterance.volume = 1.0;
  
  window.speechSynthesis.cancel();
  setTimeout(() => {
    window.speechSynthesis.speak(utterance);
  }, 50);
}

function postspeakReminder(event, minutesBefore) {
  console.log(`Speaking ${minutesBefore}-min reminder:`, event.summary);
  const message = `Hey Spade family you missed: "${event.summary || "Event"}" happened ago ${minutesBefore} minutes.`;
  const utterance = new SpeechSynthesisUtterance(message);
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;
  
  window.speechSynthesis.cancel();
  setTimeout(() => {
    window.speechSynthesis.speak(utterance);
  }, 50);
}

function stopVoiceReminders() {
  if (reminderCheckInterval) {
    clearInterval(reminderCheckInterval);
    reminderCheckInterval = null;
    spokenEvents.clear();
    console.log("Stopped voice reminders");
  }
}
  
// ===== WEATHER =====
const LAT = 38.81;
const LON = -90.72;

function loadWeather() {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&current_weather=true&forecast_days=11&timezone=auto`;

  fetch(url)
    .then(response => response.json())
    .then(data => renderWeather(data))
    .catch(error => {
      document.getElementById("weather-current").textContent = "Weather error";
      console.error("Weather error:", error);
    });
}

function renderWeather(data) {
  const current = data.current_weather;
  const daily = data.daily;
  weatherDailyData = data;
  weatherCurrentView = "daily";
  weatherSelectedDate = null;
  document.getElementById("weather-current").textContent = 
    `${Math.round(current.temperature)}¬∞ ${getWeatherDescription(current.weathercode)}`;

  const forecastEl = document.getElementById("weather-forecast");
  forecastEl.innerHTML = "";

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  let displayed = 0;

  for (let i = 0; i < daily.time.length && displayed < 11; i++) {
    const date = new Date(daily.time[i]);
    const localDate = new Date(date);
    localDate.setHours(0, 0, 0, 0);
    
    if (localDate < today) continue;

    const row = document.createElement("div");
    row.className = "weather-day";
    row.dataset.date = daily.time[i];
    row.onclick = () => showHourlyView(daily.time[i]);
    
    const icon = document.createElement("img");
    icon.className = "weather-icon";
    icon.src = getWeatherIcon(daily.weathercode[i]);
    icon.alt = getWeatherDescription(daily.weathercode[i]);

    const dayName = document.createElement("div");
    dayName.className = "weather-name";
    dayName.textContent = date.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
    });

    const temp = document.createElement("div");
    temp.className = "weather-temp";
    const high = Math.round(daily.temperature_2m_max[i]);
    const low = Math.round(daily.temperature_2m_min[i]);
    temp.textContent = `${high}¬∞ / ${low}¬∞`;

    const desc = document.createElement("div");
    desc.className = "weather-desc";
    desc.textContent = getWeatherDescription(daily.weathercode[i]);

    row.appendChild(icon);
    row.appendChild(dayName);
    row.appendChild(temp);
    row.appendChild(desc);
    forecastEl.appendChild(row);
    
    displayed++;
  }
}

function getWeatherIcon(code) {
  if (code === 0) return "icons/clear.png";
  if ([1, 2, 3].includes(code)) return "icons/partly-cloudy.png";
  if ([45, 48].includes(code)) return "icons/fog.png";
  if ([51, 53, 55, 56, 57].includes(code)) return "icons/drizzle.png";
  if ([61, 63, 65, 80, 81, 82].includes(code)) return "icons/rain.png";
  if ([71, 73, 75, 77, 85, 86].includes(code)) return "icons/snow.png";
  if ([95, 96, 99].includes(code)) return "icons/storm.png";
  return "icons/unknown.png";
}

function getWeatherDescription(code) {
  if (code === 0) return "Clear";
  if ([1, 2, 3].includes(code)) return "Cloudy";
  if ([45, 48].includes(code)) return "Fog";
  if ([51, 53, 55, 56, 57].includes(code)) return "Drizzle";
  if ([61, 63, 65, 80, 81, 82].includes(code)) return "Rain";
  if ([71, 73, 75, 77, 85, 86].includes(code)) return "Snow";
  if ([95, 96, 99].includes(code)) return "Storm";
  return "N/A";
}

// ===== HOURLY WEATHER ON DEMAND =====
const HOURLY_VARS = "temperature_2m,precipitation_probability,weathercode";
let lastSelectedDayRow = null;

function handleDayClick(row) {
  const dateStr = row.dataset.date;

  if (lastSelectedDayRow === row) {
    row.classList.remove("selected");
    lastSelectedDayRow = null;
    document.getElementById("weather-hourly-detail").innerHTML = "";
    return;
  }

  if (lastSelectedDayRow) {
    lastSelectedDayRow.classList.remove("selected");
  }
  row.classList.add("selected");
  lastSelectedDayRow = row;

  fetchHourlyForDate(dateStr);
}

function fetchHourlyForDate(dateStr) {
  const detail = document.getElementById("weather-hourly-detail");
  detail.innerHTML = "Loading hourly forecast‚Ä¶";

  const url = `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${LAT}` +
    `&longitude=${LON}` +
    `&hourly=${encodeURIComponent(HOURLY_VARS)}` +
    `&start_date=${dateStr}` +
    `&end_date=${dateStr}` +
    `&temperature_unit=fahrenheit` +
    `&timezone=auto`;

  fetch(url)
    .then(r => r.json())
    .then(data => renderHourly(data, dateStr))
    .catch(err => {
      console.error("Hourly weather error:", err);
      detail.textContent = "Hourly forecast unavailable";
    });
}

function renderHourly(data, dateStr) {
  const detail = document.getElementById("weather-hourly-detail");
  const hourly = data.hourly;
  if (!hourly || !hourly.time || hourly.time.length === 0) {
    detail.textContent = "No hourly data.";
    return;
  }

  const times = hourly.time;
  const temps = hourly.temperature_2m;
  const probs = hourly.precipitation_probability || [];
  const codes = hourly.weathercode || [];

  let html = "";
  html += `<div class="weather-hourly-title">Hourly forecast for ${
    new Date(dateStr).toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric"
    })
  }</div>`;

  html += `<div>`;
  for (let i = 0; i < times.length; i += 2) {
    const t = new Date(times[i]);
    const timeLabel = t.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    const temp = Math.round(temps[i]);
    const prob = probs[i] != null ? probs[i] : "";
    const desc = getWeatherDescription(codes[i]);

    html += `
      <div class="weather-hourly-row">
        <div>${timeLabel}</div>
        <div>${temp}¬∞</div>
        <div>${prob !== "" ? prob + "%" : ""}</div>
        <div>${desc}</div>
      </div>
    `;
  }
  html += `</div>`;

  detail.innerHTML = html;
}

function showHourlyView(dateStr) {
  weatherCurrentView = "hourly";
  weatherSelectedDate = dateStr;

  const forecastEl = document.getElementById("weather-forecast");
  forecastEl.innerHTML = `<div>Loading hourly forecast‚Ä¶</div>`;

  const url = `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${LAT}` +
    `&longitude=${LON}` +
    `&hourly=temperature_2m,precipitation_probability,weathercode` +
    `&start_date=${dateStr}` +
    `&end_date=${dateStr}` +
    `&temperature_unit=fahrenheit` +
    `&timezone=auto`;

  fetch(url)
    .then(r => r.json())
    .then(data => renderHourlyView(data, dateStr))
    .catch(err => {
      console.error("Hourly weather error:", err);
      forecastEl.innerHTML = `<div>Hourly forecast unavailable</div>`;
    });
}

function renderHourlyView(data, dateStr) {
  const forecastEl = document.getElementById("weather-forecast");
  const hourly = data.hourly;
  if (!hourly || !hourly.time || hourly.time.length === 0) {
    forecastEl.innerHTML = `<div>No hourly data.</div>`;
    return;
  }

  const times = hourly.time;
  const temps = hourly.temperature_2m;
  const probs = hourly.precipitation_probability || [];
  const codes = hourly.weathercode || [];

  let html = "";

  html += `
    <div class="weather-hourly-header">
      <button id="weather-back-btn">‚óÄ</button>
      <div class="weather-hourly-title">
        Hourly for ${new Date(dateStr).toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric",
        })}
      </div>
    </div>
  `;

  html += `<div class="weather-hourly-list">`;

  for (let i = 0; i < times.length; i += 1) {
    const t = new Date(times[i]);
    const timeLabel = t.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
    const temp = Math.round(temps[i]);
    const prob = probs[i] != null ? probs[i] : "";
    const desc = getWeatherDescription(codes[i]);

    html += `
      <div class="weather-hourly-row">
        <div>${timeLabel}</div>
        <div>${temp}¬∞</div>
        <div>${prob !== "" ? prob + "%" : ""}</div>
        <div>${desc}</div>
      </div>
    `;
  }
  html += `</div>`;

  forecastEl.innerHTML = html;

  document
    .getElementById("weather-back-btn")
    .addEventListener("click", showDailyView);
}

function showDailyView() {
  if (!weatherDailyData) return;
  weatherCurrentView = "daily";
  renderWeather(weatherDailyData);
}
  
// ===== TRADINGVIEW WIDGET =====
function initTradingViewWidget() {
  const container = document.getElementById('tradingview-widget');
  if (!container) return;
  
  container.innerHTML = '';
  
  const script = document.createElement('script');
  script.type = 'text/javascript';
  script.async = true;
  script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
  script.innerHTML = JSON.stringify({
    "symbols": [["SPY", "AMEX:SPY|1M"]],
    "chartOnly": false,
    "width": "100%",
    "height": "100%",
    "locale": "en",
    "colorTheme": "dark",
    "autosize": true,
    "showVolume": false,
    "hideMarketStatus": true,
    "scalePosition": "right",
    "scaleMode": "Normal",
    "fontFamily": "Arial, sans-serif",
    "fontSize": "08",
    "noTimeScale": false,
    "valuesTracking": "1",
    "changeMode": "price-and-percent",
    "chartType": "area",
    "gridLineColor": "rgba(255, 255, 255, 0.06)",
    "timeHoursFormat": "12-hours",
    "hideSymbolLogo": true,
    "showSymbolLogo": false,
    "widthAdjustment": -10
  });
  
  container.appendChild(script);
  
  setTimeout(() => {
    const style = document.createElement('style');
    style.textContent = `
      .tradingview-widget-copyright {
        font-size: 9px !important;
        opacity: 0.6 !important;
        margin-top: 2px !important;
      }
      .tradingview-widget-container .logo {
        transform: scale(0.7) !important;
        opacity: 0.7 !important;
      }
      .tradingview-widget-container .apply-common-tooltip {
        font-size: 11px !important;
      }
    `;
    document.head.appendChild(style);
  }, 1000);
}

// ===== INITIALIZATION =====
// ===== INITIALIZATION =====
window.addEventListener('load', () => {
  console.log("Page loaded, initializing...");
  
  // Initialize basic components
  loadWeather();
  setInterval(loadWeather, 60 * 60 * 1000);
  
  initYouTube();
  initTradingViewWidget();
  
  // Initialize credit cards
  initCreditCardsSheets().catch(error => {
    console.error("Google Sheets init failed:", error);
  });
  
  // Setup voice button
  setupVoiceAlertsButton();
  
  // Load cached events if available
  const savedEvents = localStorage.getItem('calendarEvents');
  const lastUpdated = localStorage.getItem('eventsLastUpdated');
  
  if (savedEvents && lastUpdated && (Date.now() - lastUpdated < 60 * 60 * 1000)) {
    try {
      const events = JSON.parse(savedEvents);
      renderEvents(events);
      checkVoiceEnabledForToday();
    } catch (e) {
      console.error("Error loading cached events:", e);
    }
  }
  
  // Initialize Google API
  initGoogleApi();
});

// Add sign-out button event listener
document.addEventListener('DOMContentLoaded', function() {
  const signInBtn = document.getElementById("sign-in");
  if (signInBtn) {
    // Initially set it to handle sign-in
    signInBtn.onclick = function() {
      console.log("Sign-in button clicked");
      handleSignIn();
    };
  }
});
  
// ===== CLEANUP =====
function cleanupOldReminders() {
  const now = Date.now();
  spokenEvents.clear();
  
  const today = new Date().toDateString();
  if (voiceEnabledDate && voiceEnabledDate !== today) {
    voiceEnabled = false;
    voiceEnabledDate = null;
    localStorage.removeItem('voiceEnabledDate');
    document.getElementById("enable-voice").style.display = "inline-block";
    document.getElementById("enable-voice").textContent = "Enable voice alerts";
    console.log("Voice alerts reset for new day");
  }
  
  const lastUpdated = localStorage.getItem('eventsLastUpdated');
  if (lastUpdated && (now - lastUpdated > 24 * 60 * 60 * 1000)) {
    localStorage.removeItem('calendarEvents');
    localStorage.removeItem('eventsLastUpdated');
  }
}

setInterval(cleanupOldReminders, 60 * 60 * 1000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  stopAutoRefresh();
  stopTokenMonitor();
  stopVoiceReminders();
  
  if (window.sheetsAutoSyncInterval) {
    clearInterval(window.sheetsAutoSyncInterval);
  }
});

console.log("Dashboard fully loaded!");
</script>
</body>
</html>
















