<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wall Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google APIs -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      color: white;
      overflow: hidden;
    }
    body {
      background: url("background.jpg") center / cover no-repeat;
    }
    .overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top,
        rgba(0,0,0,.35), rgba(0,0,0,.85));
      display: flex;
      padding: 16px;
      box-sizing: border-box;
    }
    .left-panel { flex: 2; display: flex; flex-direction: column; gap: 10px; }
    .right-panel { flex: 1; display: flex; flex-direction: column; gap: 16px; margin-left: 16px; }
    .panel {
      background: rgba(0,0,0,.45);
      border-radius: 8px;
      padding: 12px 16px;
    }
    #clock { font-size: 32px; font-weight: 600; }
    #date { opacity: .8; }
    .event-day { margin-top: 10px; font-weight: 600; }
    .event-item {
      margin-top: 4px;
      padding: 4px 6px;
      background: rgba(0,255,0,.05);
      border-radius: 4px;
      font-weight: bold;
    }
    .event-time { margin-right: 6px; }
    .event-location {
      font-size: 12px;
      margin-left: 65px;
      opacity: .85;
    }
    #enable-voice {
      display: none;
      margin-bottom: 6px;
      padding: 6px 10px;
      border: 1px solid white;
      background: rgba(255,255,255,.1);
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="overlay">

  <div class="left-panel">
    <div class="panel">
      <div id="clock">--:--</div>
      <div id="date"></div>
    </div>

    <div class="panel">
      <div style="font-size:18px;font-weight:600;">Upcoming Events</div>
      <button id="enable-voice">Enable voice alerts</button>
      <div id="events">Loading events…</div>
    </div>
  </div>

  <div class="right-panel">
    <div class="panel" id="weather-panel">
      <div id="weather-current">Loading weather…</div>
      <div id="weather-forecast"></div>
    </div>
    <div class="panel">
      <div id="tradingview-widget" style="height:100%;"></div>
    </div>
  </div>

</div>

<script>
/* ===== CLOCK ===== */
function updateClock() {
  const now = new Date();
  clock.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  date.textContent = now.toLocaleDateString(undefined, {
    weekday:'long', month:'long', day:'numeric'
  });
}
setInterval(updateClock, 1000);
updateClock();

/* ===== GOOGLE CALENDAR ===== */
const CLIENT_ID = "703875968822-6ma5u7st5qm3eqgb1ktt9p52vs8knrb3.apps.googleusercontent.com";
const API_KEY = "AIzaSyCcx8q0nHP9DkA-M_KFyjFo-uLV-7TOrSE";
const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";

let tokenClient, gapiReady=false, gisReady=false;
let calendarEvents = [];

function gapiLoaded() { gapi.load("client", initGapi); }
async function initGapi() {
  await gapi.client.init({ apiKey: API_KEY, discoveryDocs:[DISCOVERY_DOC] });
  gapiReady=true; maybeAuth();
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES, callback: ""
  });
  gisReady=true; maybeAuth();
}
function maybeAuth() {
  if (!(gapiReady && gisReady)) return;
  tokenClient.callback = async () => loadEvents();
  tokenClient.requestAccessToken({ prompt: "" });
}

async function loadEvents() {
  const now = new Date();
  const resp = await gapi.client.calendar.events.list({
    calendarId: "family03331431524389313579@group.calendar.google.com",
    timeMin: now.toISOString(),
    timeMax: new Date(now.getTime()+30*86400000).toISOString(),
    singleEvents: true,
    orderBy: "startTime"
  });
  calendarEvents = resp.result.items || [];
  renderEvents(calendarEvents);
  enableVoiceBtn.style.display = "inline-block";
}

/* ===== RENDER EVENTS ===== */
function renderEvents(events) {
  eventsDiv.innerHTML = "";
  events.forEach(ev => {
    const d = new Date(ev.start.dateTime || ev.start.date);
    const div = document.createElement("div");
    div.className="event-item";
    div.innerHTML = `
      <span class="event-time">${ev.start.date ? "All day" :
        d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</span>
      ${ev.summary || "(No title)"}
    `;
    eventsDiv.appendChild(div);
  });
}

/* ===== VOICE REMINDERS (FIXED) ===== */
let spoken = new Set();
let voiceLoopStarted = false;

function startVoiceReminderLoop() {
  if (voiceLoopStarted) return;
  voiceLoopStarted = true;

  speechSynthesis.getVoices(); // warm up

  setInterval(() => {
    const now = Date.now();

    calendarEvents.forEach(ev => {
      if (!ev.start?.dateTime) return;

      const start = new Date(ev.start.dateTime).getTime();
      const mins = Math.round((start - now) / 60000);

      if ((mins === 30 || mins === 15) && !spoken.has(ev.id+mins)) {
        spoken.add(ev.id+mins);

        const msg = `Reminder. ${ev.summary || "Event"} starts in ${mins} minutes.`;
        const u = new SpeechSynthesisUtterance(msg);
        speechSynthesis.cancel();
        speechSynthesis.speak(u);

        console.log("VOICE:", msg);
      }
    });
  }, 60000);
}

enableVoiceBtn.onclick = () => {
  startVoiceReminderLoop();
  enableVoiceBtn.style.display = "none";
};

/* ===== WEATHER (unchanged) ===== */
function loadWeather(){ /* omitted for brevity – keep yours */ }
loadWeather();
</script>

<!-- TradingView -->
<script>
(function(){
  const s=document.createElement("script");
  s.src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
  s.async=true;
  s.innerHTML=JSON.stringify({
    symbols:[["SPY","AMEX:SPY|1M"]],
    autosize:true, colorTheme:"dark"
  });
  document.getElementById("tradingview-widget").appendChild(s);
})();
</script>

</body>
</html>
